<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>架空世界地圖 - PLLT World</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
    
    <!-- Font Awesome 圖標庫 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 自定義CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="map"></div>
    <div class="map-title">PLLT World Map</div>
    
    <!-- 圖例視窗已被隱藏，使用圖例+過濾器整合面板 -->
    <div class="map-legend" style="display:none;">
        <h3>圖例</h3>
        <!-- 圖例會由JavaScript動態生成 -->
        <div id="map-legend-items"></div>
    </div>
    
    <!-- 標記控制面板 -->
    <div class="marker-controls collapsible-panel" data-position="right">
        <h3>標記工具</h3>
        <button id="add-marker-btn">添加標記</button>
        <button id="cancel-marker-btn" style="display:none;">取消</button>
        <div id="marker-form" style="display:none;">
            <input type="text" id="marker-name" placeholder="標記名稱">
            <select id="marker-type">
                <option value="自定義">自定義</option>
            </select>
            <textarea id="marker-description" placeholder="描述（可選）"></textarea>
            <button id="save-marker-btn">保存</button>
        </div>
        
        <!-- 距離測量工具 -->
        <div class="measure-tools">
            <h4>距離測量</h4>
            <button id="measure-distance-btn">測量距離</button>
            <button id="cancel-measure-btn" style="display:none;">取消測量</button>
            <div id="measure-result" class="measure-result" style="display:none;"></div>
        </div>
        
        <!-- 匯入/匯出工具 -->
        <div class="data-tools">
            <h4>資料管理</h4>
            <button id="export-markers-btn">匯出標記</button>
            <button id="import-markers-btn">匯入標記</button>
            <input type="file" id="import-file" accept=".json" style="display:none;">
        </div>
        
        <!-- 移除地點列表部分 -->
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- 日誌系統 - 最先加載以捕獲所有錯誤 -->
    <script src="js/logger.js"></script>
    
    <!-- 地圖資料庫 - 確保首先加載 -->
    <script src="js/locations-data.js"></script>
    
    <!-- 等待短暫時間確保數據庫初始化 -->
    <script>
        console.log("確保數據庫已載入: ", window.plltWorldData ? '成功' : '失敗');
        if (!window.plltWorldData && typeof locationDb !== 'undefined') {
            console.log("手動初始化 plltWorldData 對象");
            window.plltWorldData = {
                locations: locationDb.locations,
                categories: locationCategories
            };
        }
        
        // 調試: 輸出所有 hardcodedLocations 位置
        if (typeof hardcodedLocations !== 'undefined') {
            console.log(`找到 ${hardcodedLocations.length} 個硬編碼地點:`);
            hardcodedLocations.forEach((loc, idx) => {
                console.log(`地點 ${idx+1}: ${loc.name} (${loc.type})`);
            });
        } else {
            console.error("hardcodedLocations 未定義!");
        }
    </script>
    
    <!-- UI 模塊 -->
    <script src="js/ui.js"></script>
    
    <!-- 距離測量模塊 -->
    <script src="js/distance.js"></script>
    
    <!-- 標記模塊 -->
    <script src="js/markers.js"></script>
    
    <!-- 主要邏輯 -->
    <script src="js/main.js"></script>
    
    <!-- 初始化檢查工具 -->
    <script src="js/init-check.js"></script>
    
    <!-- 事件綁定腳本 -->
    <script>
        // 等待頁面加載後，綁定所有事件
        document.addEventListener('DOMContentLoaded', function() {
            // 標記相關按鈕
            document.getElementById('add-marker-btn').addEventListener('click', function() {
                if (window.markersModule) window.markersModule.beginAddMarker();
            });
            
            document.getElementById('cancel-marker-btn').addEventListener('click', function() {
                if (window.markersModule) window.markersModule.cancelAddMarker();
            });
            
            document.getElementById('save-marker-btn').addEventListener('click', function() {
                if (window.markersModule) window.markersModule.saveMarker();
            });
            
            // 距離測量相關按鈕
            document.getElementById('measure-distance-btn').addEventListener('click', function() {
                if (window.distanceModule) window.distanceModule.startMeasuring();
            });
            
            document.getElementById('cancel-measure-btn').addEventListener('click', function() {
                if (window.distanceModule) window.distanceModule.cancelMeasuring();
            });
            
            // 匯入/匯出相關按鈕
            document.getElementById('export-markers-btn').addEventListener('click', function() {
                if (window.markersModule) window.markersModule.exportMarkers();
            });
            
            document.getElementById('import-markers-btn').addEventListener('click', function() {
                document.getElementById('import-file').click();
            });
            
            document.getElementById('import-file').addEventListener('change', function(event) {
                if (window.markersModule) window.markersModule.handleFileImport(event);
            });
            
            // 添加一個備用的地圖點擊處理機制
            document.getElementById('map').addEventListener('click', function(e) {
                // 只有在點擊是直接發生在地圖元素上時才處理
                if (e.target === this || e.target.classList.contains('leaflet-container')) {
                    console.log('地圖元素接收到點擊');
                    
                    // 檢測是否為添加標記模式
                    if (window.markersModule && window.markersModule.isAddingMarker()) {
                        // 使用特殊方法處理
                        setTimeout(function() {
                            const mapCenter = window.map.getCenter();
                            window.uiModule.showToast('請點擊地圖任意位置');
                        }, 100);
                    }
                }
            });
            
            // 最終檢查: 確保標記被加載
            setTimeout(function() {
                console.log("最終檢查: 確保標記顯示");
                
                // 如果地圖上沒有顯示標記，強制重新初始化
                if (window.map && window.markersModule && 
                    window.plltWorldData && window.plltWorldData.locations && 
                    window.plltWorldData.locations.length > 0) {
                    
                    const visibleMarkers = document.querySelectorAll('.custom-marker-container').length;
                    console.log(`檢測到 ${visibleMarkers} 個可見標記點 (資料庫中有 ${window.plltWorldData.locations.length} 個位置)`);
                    
                    if (visibleMarkers === 0) {
                        console.log("未檢測到可見標記，強制重新初始化...");
                        window.markersModule.initializeMapLocations();
                    }
                }
            }, 2000); // 等待2秒確保地圖完全載入
            
            // 測試日誌系統
            setTimeout(function() {
                PLLTLogger.logInfo('系統測試', '日誌系統功能測試');
            }, 1000);
            
            // 匯入/匯出相關按鈕 - 修復事件綁定
            const exportBtn = document.getElementById('export-markers-btn');
            if (exportBtn) {
                // 移除可能的舊事件監聽器
                exportBtn.removeEventListener('click', function(){});
                
                // 添加新的監聽器
                exportBtn.addEventListener('click', function() {
                    console.log('點擊匯出按鈕');
                    if (window.markersModule && typeof window.markersModule.exportMarkers === 'function') {
                        window.markersModule.exportMarkers();
                    } else {
                        console.error('找不到匯出功能');
                        alert('匯出功能不可用，請使用控制台方法');
                        console.log('請在控制台運行: copy(JSON.stringify(plltWorldData.locations.map(loc => {const {markerRef, ...data} = loc; return data;}), null, 2))');
                    }
                });
                console.log('匯出按鈕事件已重新綁定');
            }
            
            // 添加快速匯出鍵盤快捷鍵
            document.addEventListener('keydown', function(e) {
                // Ctrl+Shift+E 快速匯出所有標記
                if (e.ctrlKey && e.shiftKey && (e.key === 'e' || e.key === 'E')) {
                    e.preventDefault();
                    console.log('使用鍵盤快捷鍵匯出');
                    if (window.markersModule && typeof window.markersModule.exportMarkers === 'function') {
                        window.markersModule.exportMarkers();
                    } else {
                        console.log('請在控制台運行: copy(JSON.stringify(plltWorldData.locations.map(loc => {const {markerRef, ...data} = loc; return data;}), null, 2))');
                    }
                }
            });
        });
    </script>
</body>
</html>